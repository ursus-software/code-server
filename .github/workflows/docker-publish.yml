name: Docker

on:
  push:
    branches: [ master ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}

concurrency: 
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-base:
    uses: stalkingkillah/code-server/.github/workflows/workflow-docker-build.yml@${{ github.ref }}
    with:
      registry: ${{ env.REGISTRY }}
      username: ${{ github.actor }}
      images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      flavor: |
            latest=true
            prefix=
            suffix=
      context: .
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
  build-node:
    uses: stalkingkillah/code-server/.github/workflows/workflow-docker-build.yml@${{ github.ref }}
    with:
      registry: ${{ env.REGISTRY }}
      username: ${{ github.actor }}
      images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      flavor: |
            latest=true
            prefix=node
            suffix=
      context: node/.
      build-args:
        BASE_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
